name: Generate Docs

on:
  push:
    branches:
      - main

    # see https://github.community/t/how-to-run-github-actions-workflow-only-for-new-tags/16075/10?u=tomasvotruba
    tags:
      - '*'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Cleanup docs
        run: |
          rm -rf packages/docs/docs
          mkdir packages/docs/docs

      - name: Generate docs
        uses: docker://phpdoc/phpdoc:3
        with:
          workdir: '/github/workspace'
          args: 'project:run -t packages/docs/docs'

      # no tag
      - if: "!startsWith(github.ref, 'refs/tags/')"
        name: Push main to docs
        uses: "symplify/monorepo-split-github-action@2.0"
        with:
          package-directory: "packages/${{ matrix.package }}"
          split-repository-organization: "php-addition-repository"
          split-repository-name: "php-addition-repository.github.io"
          user-name: "GitHub Action"
          user-email: "action@github.com"
          branch: "main"

      # with tag
      - if: "startsWith(github.ref, 'refs/tags/')"
        name: Push tag to docs
        uses: "symplify/monorepo-split-github-action@2.0"
        with:
          tag: ${GITHUB_REF#refs/tags/}
          package-directory: "packages/${{ matrix.package }}"
          split-repository-organization: "php-addition-repository"
          split-repository-name: "php-addition-repository.github.io"
          user-name: "GitHub Action"
          user-email: "action@github.com"
          branch: "main"
